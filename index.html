<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×§×œ×™× ×™×§×” | ×‘×¨ ×¢××¨-×¡×”×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f8fafc; color: #334155; }
        .text-brand-orange { color: #f26522; } .bg-brand-orange { background-color: #f26522; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; outline: none; transition: all 0.2s; background-color: #fff; }
        .input-field:focus { border-color: #f26522; ring: 2px solid #ffedd5; }
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 12px; transition: all 0.3s; background-color: #f8fafc; }
        .drop-zone.dragover { border-color: #f26522; background-color: #fff7ed; }
        .status-toggle { display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; position: relative; cursor: pointer; }
        .status-option { flex: 1; text-align: center; padding: 8px; font-size: 0.85rem; font-weight: bold; z-index: 10; color: #64748b; }
        .status-option.active { color: #f26522; }
        .status-slider { position: absolute; top: 4px; bottom: 4px; width: 50%; background: white; border-radius: 8px; transition: left 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto pb-12">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-slate-200 pb-6">
            <div class="text-center md:text-right">
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Bar Amar-Sahar <span class="text-brand-orange text-xl font-medium">| × ×™×”×•×œ ×§×œ×™× ×™×§×”</span></h1>
                <p class="text-xs text-slate-500 mt-1">×’×¨×¡×” 12.0 (××—×•×‘×¨×ª ×œ-Morning)</p>
            </div>
            <div class="flex gap-3">
                <button onclick="clearAllData()" class="text-xs font-bold text-red-500 bg-red-50 px-4 py-2.5 rounded-full border border-red-100 hover:bg-red-100">ğŸ—‘ï¸ ××™×¤×•×¡ × ×ª×•× ×™×</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="md:col-span-2 card p-6 border-r-8 border-brand-orange bg-gradient-to-l from-white to-orange-50 relative overflow-hidden">
                <div id="dash-patur">
                    <div class="flex justify-between items-end mb-4">
                        <div><h2 class="font-bold text-slate-700 text-lg">××¢×§×‘ ×ª×§×¨×” ×©× ×ª×™ (2026)</h2><p class="text-[11px] text-slate-500">×ª×§×¨×” ××¢×•×“×›× ×ª: 122,833 â‚ª</p></div>
                        <div class="text-2xl font-bold font-mono text-slate-800"><span id="annual-income-display">0</span> <span class="text-sm text-slate-400">/ 122,833 â‚ª</span></div>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden"><div id="ceiling-progress" class="bg-brand-orange h-full transition-all duration-1000 shadow-lg" style="width: 0%"></div></div>
                </div>
                <div id="dash-murshe" class="hidden">
                     <h2 class="font-bold text-slate-700 text-lg mb-2">××¢×§×‘ ××¢"× (18%)</h2>
                     <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-white/60 p-2 rounded-lg"> <p class="text-[10px] text-slate-500 uppercase">×¢×¡×§××•×ª</p> <p class="text-lg font-bold">â‚ª<span id="vat-collected">0</span></p> </div>
                        <div class="bg-white/60 p-2 rounded-lg"> <p class="text-[10px] text-slate-500 uppercase">×ª×©×•××•×ª</p> <p class="text-lg font-bold text-green-600">-â‚ª<span id="vat-deducted">0</span></p> </div>
                        <div class="bg-white p-2 rounded-lg border border-orange-200"> <p class="text-[10px] text-slate-500 font-bold">×œ×ª×©×œ×•×</p> <p class="text-xl font-bold text-brand-orange">â‚ª<span id="vat-to-pay">0</span></p> </div>
                     </div>
                </div>
            </div>
            <div class="card p-5 flex flex-col h-40 md:h-auto overflow-hidden">
                <h3 class="text-xs font-bold text-slate-400 mb-3 uppercase">×—×•×“×©×™× ×©××•×¨×™×</h3>
                <div class="overflow-y-auto flex-grow space-y-2 pr-1" id="history-list-container"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="card p-6">
                    <h3 class="font-bold border-b pb-3 mb-5 text-slate-700">âš™ï¸ ×¤×¨×•×¤×™×œ ××¡</h3>
                    <div class="mb-6">
                        <div class="status-toggle" onclick="toggleStatus()">
                            <div id="slider" class="status-slider left-1"></div>
                            <div id="opt-patur" class="status-option active">×¢×•×¡×§ ×¤×˜×•×¨</div>
                            <div id="opt-murshe" class="status-option">×¢×•×¡×§ ××•×¨×©×”</div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500">×™×œ×“×™× (&lt;18)</label><input type="number" id="children" value="0" class="input-field" oninput="calculate()"></div>
                            <div><label class="text-xs font-bold text-slate-500">××™×Ÿ</label><select id="gender" class="input-field" onchange="calculate()"><option value="female">××™×©×”</option><option value="male">×’×‘×¨</option></select></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-500">×‘×¨×•×˜×• ×›×©×›×™×¨/×”</label><input type="number" id="salary" value="0" class="input-field bg-blue-50" oninput="calculate()"></div>
                        <div class="flex flex-col gap-2 p-3 bg-slate-50 rounded-lg">
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="degree" onchange="calculate()"> ×ª×•××¨ ××§×“××™ (+1 × ×§')</label>
                            <label class="flex items-center gap-2 text-xs"><input type="checkbox" id="periphery" onchange="calculate()"> ×™×™×©×•×‘ ××•×˜×‘ (×¤×¨×™×¤×¨×™×”)</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-8">
                
                <div class="card p-6 border-t-4 border-brand-orange">
                    <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2">ğŸ’° ×”×›× ×¡×•×ª <span id="vat-inc-label" class="text-[10px] text-slate-400 hidden">(×›×•×œ×œ ××¢"×)</span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="income-inputs-container">
                        <div class="input-group"><label class="text-xs font-bold text-slate-400">×˜×™×¤×•×œ×™×</label><input type="number" data-group="inc" class="input-field" oninput="calculate()"></div>
                        <div class="input-group"><label class="text-xs font-bold text-slate-400">×”×¨×¦××•×ª</label><input type="number" data-group="inc" class="input-field" oninput="calculate()"></div>
                        <div class="input-group"><label class="text-xs font-bold text-slate-400">××‘×—×•× ×™×</label><input type="number" data-group="inc" class="input-field" oninput="calculate()"></div>
                        <div id="dynamic-income-wrapper" class="contents"></div>
                    </div>
                    <div id="income-chart-wrapper" class="mt-6 pt-4 border-t hidden">
                        <div class="flex justify-between text-lg font-bold mb-4"><span>×¡×”"×› ×”×›× ×¡×•×ª:</span><span>â‚ª<span id="total-income-val">0</span></span></div>
                        <div class="h-40"><canvas id="incomeChart"></canvas></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="drop-zone p-10 text-center cursor-pointer relative" id="drop-zone">
                        <input type="file" id="morning-csv-input" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleMorningUpload(this)">
                        <div>
                            <span class="text-4xl mb-2 block">ğŸ“„</span>
                            <h4 class="font-bold text-slate-700">×™×™×‘×•× ×“×•"×— ×”×•×¦××•×ª ×-Morning</h4>
                            <p class="text-xs text-slate-400 mt-1">×’×¨×¨×™ ×œ×›××Ÿ ××ª ×§×•×‘×¥ ×”-CSV ×©×”×•×¨×“×ª ××”×ª×•×›× ×”</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card p-5 border-t-4 border-slate-400">
                            <h3 class="font-bold text-slate-700 text-sm mb-4">ğŸ“Œ ×”×•×¦××•×ª ×§×‘×•×¢×•×ª</h3>
                            <div id="fixed-exp-container" class="space-y-3"></div>
                            <div id="dynamic-fixed-wrapper" class="space-y-3 mt-3"></div>
                            <div id="fixed-chart-wrapper" class="mt-4 pt-4 border-t hidden"><div class="h-32"><canvas id="fixedChart"></canvas></div></div>
                        </div>
                        <div class="card p-5 border-t-4 border-red-400">
                            <h3 class="font-bold text-slate-700 text-sm mb-4">âš¡ ×”×•×¦××•×ª ××©×ª× ×•×ª</h3>
                            <div id="var-exp-container" class="space-y-3"></div>
                            <div id="dynamic-var-wrapper" class="space-y-3 mt-3"></div>
                            <div id="var-chart-wrapper" class="mt-4 pt-4 border-t hidden"><div class="h-32"><canvas id="varChart"></canvas></div></div>
                        </div>
                    </div>
                </div>

                <div id="results-area" class="opacity-0 transition-opacity duration-700 space-y-6 pb-20">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="card p-4"> <p class="text-[10px] text-slate-400 font-bold">××™×¡×™× ×•×‘×™×˜×•×—</p> <p class="text-xl font-bold">â‚ª<span id="res-tax">0</span></p> </div>
                        <div class="card p-4"> <p class="text-[10px] text-slate-400 font-bold">×¤× ×¡×™×” ×—×•×‘×”</p> <p class="text-xl font-bold">â‚ª<span id="res-pension">0</span></p> </div>
                        <div class="card p-4"> <p class="text-[10px] text-slate-400 font-bold">×§×”"×©</p> <p class="text-xl font-bold">â‚ª<span id="res-study">0</span></p> </div>
                    </div>
                    <div class="card bg-slate-900 text-white p-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-brand-orange rounded-full blur-3xl opacity-20"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div><h4 class="text-3xl font-bold">× ×˜×• ×”×‘×™×ª×”</h4><p class="text-xs text-slate-400 mt-1">××—×¨×™ ×”×›×œ - ×–×” ×”×›×¡×£ ×©×œ×š</p></div>
                            <div class="text-5xl font-bold text-brand-orange">â‚ª<span id="res-net">0</span></div>
                        </div>
                    </div>
                    <button onclick="saveMonthToHistory()" class="w-full bg-brand-orange text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-orange-600 transition">âœ… ×©××•×¨ ×—×•×“×© ×–×” ×‘×™×•××Ÿ ×”×©× ×ª×™</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mappings from Classifications.csv and UI synonyms
        const PERCENT_MAP = {
            '×”×•×¦××•×ª ×“×œ×§': 45, '××—×–×§×ª ×¨×›×‘ (×œ×œ× ×“×œ×§)': 45, '××™× ×˜×¨× ×˜': 25, '××¨× ×•× ×”': 25, '×”×•×¦××•×ª ×ª×§×©×•×¨×ª ×•×˜×œ×¤×•×Ÿ': 25, '×—×©××œ ××™× ×’×–': 25,
            '×©×›×™×¨×•×ª': 100, '×¨×•"×—': 100, '×”×“×¨×›×”': 100, '×™×¢×•×¥ ×¢×¡×§×™': 100, '×¤×¨×¡×•× ×•×©×™×•×•×§': 100, '×ª×•×›× ×•×ª, ×× ×•×™×™×': 100
        };
        const SYNONYMS = { '×¨×•××” ×—×©×‘×•×Ÿ': ['×¨×•"×—', '×¨×•××” ×—×©×‘×•×Ÿ'], '×¨×›×‘': ['×”×•×¦××•×ª ×“×œ×§', '××—×–×§×ª ×¨×›×‘'], '×ª×§×©×•×¨×ª': ['××™× ×˜×¨× ×˜', '×˜×œ×¤×•×Ÿ', '×ª×§×©×•×¨×ª'] };

        const C = { CEILING: 122833, AVG_WAGE: 13683, VAT_RATE: 0.18, CREDIT_POINT: 255, BITUACH_LIMIT: 8210, TAX: [{ limit: 7250, rate: 0.10 }, { limit: 10410, rate: 0.14 }, { limit: 16710, rate: 0.20 }, { limit: 23230, rate: 0.31 }, { limit: 48000, rate: 0.35 }] };
        const FIXED_DEFAULTS = [{ id: "acc", label: "×¨×•××” ×—×©×‘×•×Ÿ" }, { id: "soft", label: "×ª×•×›× ×•×ª ×•×× ×•×™×™×" }, { id: "rent", label: "×©×›×™×¨×•×ª/××¨× ×•× ×”" }, { id: "phone", label: "×˜×œ×¤×•×Ÿ ×•×ª×§×©×•×¨×ª" }];
        const VAR_DEFAULTS = [{ id: "car_var", label: "×¨×›×‘ (×“×œ×§/×˜×™×¤×•×œ)" }, { id: "mat", label: "×—×•××¨×™× ××ª×›×œ×™×" }, { id: "food", label: "×›×™×‘×•×“" }];

        let history = JSON.parse(localStorage.getItem('osek_history_v12')) || [];
        let savedFixed = JSON.parse(localStorage.getItem('osek_fixed_v12')) || {};
        let savedDynamic = JSON.parse(localStorage.getItem('osek_dynamic_v12')) || { inc: [], fixed: [], var: [] };
        let isMurshe = localStorage.getItem('is_murshe') === 'true';
        let incomeChart = null, fixedChart = null, varChart = null;

        window.onload = () => {
            renderExpenses(); renderDynamicInputs('inc'); initCharts(); updateStatusUI(); calculate(); updateAnnualDashboard(); renderHistoryList();
            const dropZone = document.getElementById('drop-zone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleMorningUpload({ files: e.dataTransfer.files }); });
        };

        function toggleStatus() { isMurshe = !isMurshe; localStorage.setItem('is_murshe', isMurshe); updateStatusUI(); calculate(); }

        function updateStatusUI() {
            document.getElementById('slider').style.left = isMurshe ? '50%' : '4px';
            document.getElementById('dash-patur').classList.toggle('hidden', isMurshe);
            document.getElementById('dash-murshe').classList.toggle('hidden', !isMurshe);
            document.getElementById('vat-inc-label').classList.toggle('hidden', !isMurshe);
        }

        function renderExpenses() {
            const gen = (item, type) => `<div class="flex flex-col"><label class="text-[11px] font-bold text-slate-500">${item.label}</label><div class="flex gap-1 h-9"><input type="number" id="inp-${type}-${item.id}" data-group="${type}" data-id="${item.id}" value="${savedFixed[item.id]?.val || ''}" class="input-field text-sm flex-grow" oninput="calculate()"><select data-freq="${item.id}" class="text-[10px] border rounded w-16" onchange="calculate()"><option value="1" ${savedFixed[item.id]?.freq=='1'?'selected':''}>×—×•×“×©×™</option><option value="12" ${savedFixed[item.id]?.freq=='12'?'selected':''}>×©× ×ª×™</option></select></div></div>`;
            document.getElementById('fixed-exp-container').innerHTML = FIXED_DEFAULTS.map(i => gen(i, 'fixed')).join('');
            document.getElementById('var-exp-container').innerHTML = VAR_DEFAULTS.map(i => `<div class="flex flex-col"><label class="text-[11px] font-bold text-slate-500">${i.label}</label><input type="number" data-group="var" class="input-field text-sm h-9" oninput="calculate()">`).join('');
        }

        function renderDynamicInputs(type) {
            const wrapper = document.getElementById(type === 'inc' ? 'dynamic-income-wrapper' : (type === 'fixed' ? 'dynamic-fixed-wrapper' : 'dynamic-var-wrapper'));
            wrapper.innerHTML = '';
            savedDynamic[type].forEach((f, idx) => wrapper.appendChild(createRow(type, idx, f.label, f.val, f.freq)));
            wrapper.appendChild(createRow(type, savedDynamic[type].length, '', '', '1'));
        }

        function createRow(type, idx, l, v, f) {
            const div = document.createElement('div'); div.className = 'flex flex-col dynamic-row';
            const inputLabel = `<input type="text" placeholder="××—×¨..." value="${l}" class="editable-label text-xs font-bold" oninput="saveDyn('${type}',${idx},'label',this.value)">`;
            const inputs = `<div class="flex gap-1 h-9"><input type="number" value="${v}" class="input-field text-sm flex-grow" oninput="saveDyn('${type}',${idx},'val',this.value);calculate()">${type==='fixed'?'<select class="text-[10px] border rounded w-16" onchange="saveDyn(\'fixed\','+idx+',\'freq\',this.value);calculate()"><option value="1" '+(f=='1'?'selected':'')+'>×—×•×“×©×™</option><option value="12" '+(f=='12'?'selected':'')+'>×©× ×ª×™</option></select>':''}</div>`;
            div.innerHTML = inputLabel + inputs; return div;
        }

        function saveDyn(t, i, k, v) { 
            if(!savedDynamic[t][i]) { savedDynamic[t][i] = {label:'', val:'', freq:'1'}; renderDynamicInputs(t); }
            savedDynamic[t][i][k] = v; localStorage.setItem('osek_dynamic_v12', JSON.stringify(savedDynamic));
        }

        function handleMorningUpload(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                processMorningData(json);
            };
            reader.readAsArrayBuffer(file);
        }

        function processMorningData(data) {
            let count = 0;
            data.forEach(row => {
                const rawCat = row['×ª×™××•×¨ ×—×©×‘×•×Ÿ ×”×•×¦××”'] || row['Category'];
                const amount = parseFloat(row['×¡×›×•× ×›×•×œ×œ'] || row['×¡×›×•× ×›×•×œ×œ ××¢×´×'] || row['Amount']) || 0;
                const logic = (row['Logic'] || '××©×ª× ×”').trim();
                const pct = PERCENT_MAP[rawCat] || 100;
                const finalAmount = amount * (pct / 100);
                if(finalAmount === 0 || !rawCat) return;

                let type = logic.includes('×§×‘×•×¢×”') ? 'fixed' : 'var';
                let freq = logic.includes('×©× ×ª×™') ? '12' : '1';

                // Try matching to UI
                let matched = false;
                [...FIXED_DEFAULTS, ...VAR_DEFAULTS].forEach(def => {
                    if(def.label === rawCat || (SYNONYMS[def.label] && SYNONYMS[def.label].includes(rawCat))) {
                        const inp = document.querySelector(`[data-id="${def.id}"]`) || document.querySelector(`[data-group="var"]`);
                        if(inp) { inp.value = Math.round((parseFloat(inp.value)||0) + finalAmount); matched = true; }
                    }
                });

                if(!matched) {
                    let dyn = savedDynamic[type].find(d => d.label === rawCat);
                    if(dyn) dyn.val = (parseFloat(dyn.val)||0) + finalAmount;
                    else savedDynamic[type].push({ label: rawCat, val: finalAmount, freq: freq });
                }
                count++;
            });
            localStorage.setItem('osek_dynamic_v12', JSON.stringify(savedDynamic));
            renderDynamicInputs('fixed'); renderDynamicInputs('var'); calculate();
            alert(`× ×§×œ×˜×• ${count} ×©×•×¨×•×ª ××”×“×•"×— ×©×œ Morning!`);
        }

        function calculate() {
            let tInc = 0, incVs = [], incLs = [];
            document.querySelectorAll('[data-group="inc"]').forEach(i => { const v = parseFloat(i.value)||0; if(v>0){ tInc+=v; incVs.push(v); incLs.push(i.previousElementSibling.innerText); }});
            savedDynamic.inc.forEach(d => { const v = parseFloat(d.val)||0; if(v>0){ tInc+=v; incVs.push(v); incLs.push(d.label||"××—×¨"); }});
            
            let tFix = 0, fixVs = [], fixLs = [];
            document.querySelectorAll('[data-group="fixed"]').forEach(i => { const f = parseFloat(document.querySelector(`[data-freq="${i.dataset.id}"]`).value); const v = (parseFloat(i.value)||0)/f; tFix+=v; if(v>0){ fixVs.push(v); fixLs.push(i.parentElement.previousElementSibling.innerText); }});
            savedDynamic.fixed.forEach(d => { const v = (parseFloat(d.val)||0)/(parseFloat(d.freq)||1); tFix+=v; if(v>0){ fixVs.push(v); fixLs.push(d.label||"××—×¨"); }});

            let tVar = 0, varVs = [], varLs = [];
            document.querySelectorAll('[data-group="var"]').forEach(i => { const v = parseFloat(i.value)||0; tVar+=v; if(v>0){ varVs.push(v); varLs.push(i.previousElementSibling.innerText); }});
            savedDynamic.var.forEach(d => { const v = parseFloat(d.val)||0; tVar+=v; if(v>0){ varVs.push(v); varLs.push(d.label||"××—×¨"); }});

            document.getElementById('total-income-val').innerText = tInc.toLocaleString();
            document.getElementById('income-chart-wrapper').classList.toggle('hidden', tInc===0);
            updateChart(incomeChart, incVs, incLs);
            document.getElementById('fixed-chart-wrapper').classList.toggle('hidden', tFix===0);
            updateChart(fixedChart, fixVs, fixLs);
            document.getElementById('var-chart-wrapper').classList.toggle('hidden', tVar===0);
            updateChart(varChart, varVs, varLs);

            let profit = isMurshe ? (tInc/1.18 - (tFix+tVar)/1.18) : (tInc - (tFix+tVar));
            if(isMurshe) {
                const vCol = tInc - tInc/1.18, vDed = (tFix+tVar) - (tFix+tVar)/1.18;
                document.getElementById('vat-collected').innerText = Math.round(vCol).toLocaleString();
                document.getElementById('vat-deducted').innerText = Math.round(vDed).toLocaleString();
                document.getElementById('vat-to-pay').innerText = Math.round(vCol - vDed).toLocaleString();
            }
            
            const sal = parseFloat(document.getElementById('salary').value)||0;
            const pts = (document.getElementById('gender').value==='male'?2.25:2.75) + parseInt(document.getElementById('children').value||0) + (document.getElementById('degree').checked?1:0);
            const rawTax = calcTax(sal + profit) - calcTax(sal);
            const netTax = Math.max(0, rawTax - (pts * C.CREDIT_POINT));
            const bituach = Math.min(profit, C.BITUACH_LIMIT)*0.0597 + Math.max(0, profit-C.BITUACH_LIMIT)*0.1783;
            const pens = Math.min(profit, 13683)*0.12, study = profit*0.045;
            
            document.getElementById('res-tax').innerText = Math.round(netTax + bituach).toLocaleString();
            document.getElementById('res-pension').innerText = Math.round(pens).toLocaleString();
            document.getElementById('res-study').innerText = Math.round(study).toLocaleString();
            document.getElementById('res-net').innerText = Math.round(profit - netTax - bituach - pens - study).toLocaleString();
            document.getElementById('results-area').style.opacity = tInc > 0 ? "1" : "0";
        }

        function calcTax(n) { let t=0, p=0; for(let b of C.TAX){ if(n>p){ t+=Math.min(n-p, b.limit-p)*b.rate; p=b.limit; } } if(n>p) t+=(n-p)*0.47; return t; }
        function initCharts() {
            const conf = (id) => new Chart(document.getElementById(id).getContext('2d'), { type:'doughnut', data:{labels:[],datasets:[{data:[],backgroundColor:['#f26522','#334155','#94a3b8','#fdba74','#cbd5e1','#e2e8f0']}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{family:'Rubik',size:10},boxWidth:8}}}}});
            incomeChart = conf('incomeChart'); fixedChart = conf('fixedChart'); varChart = conf('varChart');
        }
        function updateChart(c, v, l) { if(!c)return; c.data.labels=l; c.data.datasets[0].data=v; c.update(); }
        function updateAnnualDashboard() {
            const total = history.filter(h => h.month.startsWith('2026')).reduce((s, h) => s + h.income, 0);
            document.getElementById('annual-income-display').innerText = total.toLocaleString();
            document.getElementById('ceiling-progress').style.width = Math.min(100, (total/C.CEILING)*100) + "%";
        }
        function renderHistoryList() {
            const cont = document.getElementById('history-list-container');
            cont.innerHTML = history.length ? history.map(h => `<div class="flex justify-between text-[10px] bg-slate-50 p-1.5 rounded"><b>${h.month}</b><span class="text-brand-orange font-bold">â‚ª${h.income.toLocaleString()}</span></div>`).join('') : '<p class="text-center text-xs text-slate-400">×¨×™×§</p>';
        }
        function saveMonthToHistory() {
            const inc = parseFloat(document.getElementById('total-income-val').innerText.replace(/,/g,'')), m = new Date().toISOString().slice(0,7);
            history = history.filter(h => h.month !== m); history.push({month:m, income:inc});
            localStorage.setItem('osek_history_v12', JSON.stringify(history)); updateAnnualDashboard(); renderHistoryList(); alert("× ×©××¨!");
        }
        function clearAllData() { if(confirm("×œ××—×•×§ ×”×›×œ?")){ localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
