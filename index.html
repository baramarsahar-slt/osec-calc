<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×¢×•×¡×§ ×¤×˜×•×¨ 2026 | V7.0 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 2px; }
        .input-field { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem; outline: none; transition: border 0.2s; }
        .input-field:focus { border-color: #3b82f6; ring: 2px solid #bfdbfe; }
        
        /* Custom Editable Label Style */
        .editable-label { border-bottom: 1px dashed #94a3b8; cursor: text; color: #334155; font-weight: bold; background: transparent; width: 100%; font-size: 0.8rem; }
        .editable-label:focus { outline: none; border-bottom: 2px solid #3b82f6; color: #000; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-800">

    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 italic">Smart Biz Manager <span class="text-blue-600 text-lg">V7.0</span></h1>
                <p class="text-xs text-slate-500">××¢×¨×›×ª × ×™×”×•×œ ×—×›××” ×œ×¢×•×¡×§ ×¤×˜×•×¨ (××•×ª×× ×œ××˜×¤×œ×™×)</p>
            </div>
            <div class="flex gap-2">
                <button onclick="exportToCSV()" class="text-xs bg-white text-slate-700 px-3 py-2 rounded-lg border hover:bg-slate-50 transition shadow-sm">ğŸ“¥ ×™×™×¦×•× ×“×•×—</button>
                <button onclick="clearAllData()" class="text-xs bg-red-50 text-red-600 px-3 py-2 rounded-lg border border-red-100 hover:bg-red-100 transition shadow-sm">ğŸ—‘ï¸ ××™×¤×•×¡ ××¢×¨×›×ª</button>
            </div>
        </div>

        <div class="card p-6 mb-8 border-r-8 border-yellow-400 bg-gradient-to-l from-white to-yellow-50">
            <div class="flex justify-between items-end mb-3">
                <div>
                    <h2 class="font-bold text-slate-700 text-lg">××¢×§×‘ ×ª×§×¨×” ×©× ×ª×™ (2026)</h2>
                    <p class="text-[10px] text-slate-500">×¢×“ 120,000 â‚ª ×œ×¢×•×¡×§ ×¤×˜×•×¨</p>
                </div>
                <div class="text-xl font-bold font-mono"><span id="annual-income-display">0</span> / 120,000 â‚ª</div>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                <div id="ceiling-progress" class="bg-yellow-400 h-full transition-all duration-1000 striped-bar" style="width: 0%"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div class="card p-5">
                    <h3 class="font-bold border-b pb-2 mb-4 text-slate-700">âš™ï¸ ×¤×¨×•×¤×™×œ ×œ×—×™×©×•×‘ ××¡</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] uppercase font-bold text-slate-500">××™×Ÿ</label>
                                <select id="gender" class="input-field bg-slate-50" onchange="calculate()">
                                    <option value="female">××™×©×”</option><option value="male">×’×‘×¨</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-slate-500">×™×œ×“×™× (&lt;18)</label>
                                <input type="number" id="children" value="0" class="input-field bg-slate-50" oninput="calculate()">
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500">×‘×¨×•×˜×• ×—×•×“×©×™ ×›×©×›×™×¨/×”</label>
                            <input type="number" id="salary" placeholder="0" class="input-field bg-blue-50 border-blue-200" oninput="calculate()">
                        </div>

                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-2">
                            <p class="text-[10px] font-bold text-slate-400 mb-1">×–×™×›×•×™×™× × ×•×¡×¤×™× (××©×•×¢×¨):</p>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="degree" class="w-4 h-4 text-blue-600 rounded" onchange="calculate()">
                                <span class="text-xs">×–×›××•×ª ×œ×ª×•××¨ ××§×“××™ (+1 × ×§')</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="periphery" class="w-4 h-4 text-blue-600 rounded" onchange="calculate()">
                                <span class="text-xs">×ª×•×©×‘ ×¤×¨×™×¤×¨×™×” (×”× ×—×ª ××¡)</span>
                            </label>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-xs whitespace-nowrap">× ×§' × ×•×¡×¤×•×ª:</span>
                                <input type="number" id="extraPoints" value="0" min="0" step="0.5" class="w-16 p-1 text-xs border rounded" oninput="calculate()">
                                <span class="text-[10px] text-slate-400">(×¢×•×œ×” ×—×“×©/×¦×‘×)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="status-card" class="card p-5 bg-slate-800 text-white shadow-lg">
                    <h3 class="font-bold text-blue-300 mb-3 text-sm flex items-center gap-2">
                        <span>ğŸ“Š ×¡×˜×˜×•×¡ ××¡ ×‘×–××Ÿ ×××ª</span>
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-slate-400">××“×¨×’×ª ××¡ ×©×•×œ×™×ª</div>
                            <div id="status-tax-bracket" class="text-2xl font-bold text-white">10%</div>
                        </div>
                        <div class="pt-3 border-t border-slate-700">
                            <div id="status-next-bracket" class="text-xs text-blue-100 leading-relaxed opacity-90">
                                ×˜×•×¢×Ÿ × ×ª×•× ×™×...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                
                <div class="card p-6 border-t-4 border-green-500">
                    <h3 class="font-bold text-green-700 mb-4 flex items-center gap-2">
                        <span>ğŸ’° ×”×›× ×¡×•×ª ×”×—×•×“×©</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="input-group"><label>×˜×™×¤×•×œ×™×</label><input type="number" data-group="inc" class="input-field border-green-100 focus:border-green-500" oninput="calculate()"></div>
                        <div class="input-group"><label>×”×¨×¦××•×ª</label><input type="number" data-group="inc" class="input-field border-green-100 focus:border-green-500" oninput="calculate()"></div>
                        <div class="input-group"><label>××‘×—×•× ×™×</label><input type="number" data-group="inc" class="input-field border-green-100 focus:border-green-500" oninput="calculate()"></div>
                        <div class="input-group"><label>×”×“×¨×›×”</label><input type="number" data-group="inc" class="input-field border-green-100 focus:border-green-500" oninput="calculate()"></div>
                        <div class="input-group"><label>×™×¢×•×¥ ××§×¦×•×¢×™</label><input type="number" data-group="inc" class="input-field border-green-100 focus:border-green-500" oninput="calculate()"></div>
                        <div class="input-group">
                            <input type="text" value="××—×¨ (×œ×—×¥ ×œ×¢×¨×™×›×”)" class="editable-label text-green-700 mb-1">
                            <input type="number" data-group="inc" class="input-field border-green-100 focus:border-green-500" oninput="calculate()">
                        </div>
                    </div>
                    <div class="mt-4 text-right font-bold text-green-800 text-sm">×¡×”"×› ×”×›× ×¡×•×ª: â‚ª<span id="total-income-val">0</span></div>
                </div>

                <div class="card p-6 border-t-4 border-slate-400">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700">ğŸ“Œ ×”×•×¦××•×ª ×§×‘×•×¢×•×ª (× ×©××¨×•×ª)</h3>
                        <button onclick="saveFixedExpenses()" class="text-[10px] bg-slate-700 text-white px-3 py-1.5 rounded hover:bg-slate-800 transition">×©××•×¨ ×”×’×“×¨×•×ª ×§×‘×•×¢×•×ª</button>
                    </div>
                    <div class="mt-2 mb-4 p-3 bg-amber-50 rounded-lg border border-amber-100 text-[11px] text-amber-800">
                        <strong>×˜×™×¤ ×ª×–×¨×™××™:</strong> ××•××œ×¥ ×œ×”×–×™×Ÿ ×”×•×¦××•×ª ×©× ×ª×™×•×ª (×›××• ×‘×™×˜×•×—) ×‘×¡×›×•× ×”××œ× ×•×œ×‘×—×•×¨ "×©× ×ª×™". ×”××¢×¨×›×ª ×ª×—×©×‘ ××•×˜×•××˜×™×ª ××ª ×”×¢×œ×•×ª ×”×—×•×“×©×™×ª ×”×××™×ª×™×ª.
                    </div>
                    <div id="fixed-exp-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        </div>
                </div>

                <div class="card p-6 border-t-4 border-red-500">
                    <h3 class="font-bold text-red-700 mb-4">âš¡ ×”×•×¦××•×ª ××©×ª× ×•×ª (×—×•×“×©×™ ×‘×œ×‘×“)</h3>
                    <div id="var-exp-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                         </div>
                    <div class="mt-4 p-3 bg-blue-50 text-blue-800 text-xs rounded border border-blue-100 flex gap-2 items-start">
                        <span class="text-lg">ğŸ§®</span>
                        <div>
                            <strong>×”×•×¦××•×ª ××¢×•×¨×‘×•×ª (×¨×›×‘/×‘×™×ª):</strong> ×”×©×ª××©×™ ×‘×›×¤×ª×•×¨ ×”××—×©×‘×•×Ÿ ×©×œ×™×“ ×”×©×“×” ×›×“×™ ×œ×—×©×‘ ××ª ×”×—×œ×§ ×”××•×›×¨ (×œ××©×œ 45% ×œ×¨×›×‘, 25% ×œ×‘×™×ª) ×œ×¤×™ ×”××œ×¦×ª ×¨×•"×—.
                        </div>
                    </div>
                    <div id="receipt-reminder" class="hidden mt-2 p-2 bg-red-50 text-red-700 text-xs rounded border border-red-100 italic font-bold">
                        âš ï¸ ×ª×–×›×•×¨×ª: × × ×œ×©××•×¨ ×§×‘×œ×•×ª ×•×œ×ª×¢×“ ××ª ×”×”×•×¦××•×ª ×”×œ×œ×• ×‘××¢×¨×›×ª ×”× ×”×œ×ª ×”×—×©×‘×•× ×•×ª!
                    </div>
                </div>

                <div id="results-area" class="opacity-0 transition-opacity duration-700 space-y-4 pb-12">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="card p-4 bg-orange-50 border border-orange-100 text-center">
                            <div class="text-[10px] font-bold text-orange-600 uppercase">××™×¡×™× ×•×‘×™×˜×•×—</div>
                            <div id="res-tax" class="text-xl font-bold text-slate-800">0</div>
                        </div>
                        <div class="card p-4 bg-purple-50 border border-purple-100 text-center">
                            <div class="text-[10px] font-bold text-purple-600 uppercase">×¤× ×¡×™×” ×—×•×‘×”</div>
                            <div id="res-pension" class="text-xl font-bold text-slate-800">0</div>
                        </div>
                        <div class="card p-4 bg-blue-50 border border-blue-100 text-center">
                            <div class="text-[10px] font-bold text-blue-600 uppercase">×§×”"×© (×”××œ×¦×”)</div>
                            <div id="res-study" class="text-xl font-bold text-slate-800">0</div>
                        </div>
                    </div>
                    
                    <div class="card bg-slate-800 text-white p-6 shadow-2xl relative overflow-hidden group hover:scale-[1.01] transition-transform">
                        <div class="absolute top-0 left-0 w-2 h-full bg-green-500"></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div>
                                <h4 class="text-2xl font-bold text-green-400">× ×˜×• ×”×‘×™×ª×”</h4>
                                <p class="text-[11px] text-slate-400 mt-1">××—×¨×™ ×”×›×œ - ×–×” ×”×›×¡×£ ×©×œ×š.</p>
                            </div>
                            <div class="text-5xl font-bold tracking-tight">â‚ª<span id="res-net">0</span></div>
                        </div>
                    </div>

                    <button onclick="saveMonthToHistory()" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl hover:bg-green-700 transition shadow-lg flex justify-center items-center gap-2">
                        <span>âœ…</span>
                        <span>×©××•×¨ ×—×•×“×© ×–×” ×‘×¡×™×›×•× ×”×©× ×ª×™</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="calcModal" class="modal flex">
        <div class="modal-content">
            <h3 class="font-bold text-lg mb-4 text-slate-700">ğŸ§® ×—×™×©×•×‘ ×”×•×¦××” ××•×›×¨×ª</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold mb-1">×¡×›×•× ×”×—×©×‘×•× ×™×ª ×”××œ× (×©"×—)</label>
                    <input type="number" id="modal-full-amount" class="input-field text-lg" placeholder="×œ××©×œ: 500">
                </div>
                <div>
                    <label class="block text-xs font-bold mb-1">××—×•×– ××•×›×¨ (%)</label>
                    <div class="flex gap-2">
                        <button onclick="setModalPercent(25)" class="bg-slate-100 text-xs px-3 py-2 rounded hover:bg-slate-200">25% (×‘×™×ª)</button>
                        <button onclick="setModalPercent(45)" class="bg-slate-100 text-xs px-3 py-2 rounded hover:bg-slate-200">45% (×¨×›×‘)</button>
                        <input type="number" id="modal-percent" value="45" class="input-field w-20 text-center">
                    </div>
                </div>
                <div class="bg-blue-50 p-3 rounded text-center">
                    <div class="text-xs text-blue-500">×¡×›×•× ×©×™×•×›×¨ ×›×”×•×¦××”:</div>
                    <div class="text-2xl font-bold text-blue-700">â‚ª<span id="modal-result">0</span></div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="closeModal()" class="w-1/3 bg-gray-200 text-gray-700 py-2 rounded font-bold text-sm">×‘×™×˜×•×œ</button>
                    <button onclick="applyModalResult()" class="w-2/3 bg-blue-600 text-white py-2 rounded font-bold text-sm">×”×©×ª××© ×‘×¡×›×•× ×–×”</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const C = {
            CEILING: 120000,
            AVG_WAGE: 13683,
            PENSION_R1: 0.0445, PENSION_R2: 0.1255,
            STUDY_FUND: 0.045, CREDIT_POINT: 255,
            BITUACH_LIMIT: 8210, BITUACH_R1: 0.0597, BITUACH_R2: 0.1783,
            TAX: [
                { limit: 7250, rate: 0.10 },
                { limit: 10410, rate: 0.14 },
                { limit: 16710, rate: 0.20 },
                { limit: 23230, rate: 0.31 },
                { limit: 48000, rate: 0.35 }
            ]
        };

        const FIXED_EXP_LIST = [
            { id: "acc", label: "×¨×•××” ×—×©×‘×•×Ÿ" },
            { id: "soft", label: "×ª×•×›× ×•×ª ×•×× ×•×™×™×" },
            { id: "rent", label: "×©×›×™×¨×•×ª/××¨× ×•× ×”", calc: true }, // calc=true adds calculator btn
            { id: "assoc", label: "×—×‘×¨×•×ª ×‘××’×•×“×”" },
            { id: "ins", label: "×‘×™×˜×•×—×™×" },
            { id: "clinic", label: "××¢×¨×›×ª ×œ× ×™×”×•×œ ×§×œ×™× ×™×§×”" },
            { id: "inv", label: "×××©×§ ×—×©×‘×•× ×™×•×ª" },
            { id: "phone", label: "×˜×œ×¤×•×Ÿ ×•×ª×§×©×•×¨×ª", calc: true },
            { id: "train_fix", label: "×”×“×¨×›×” (×§×‘×•×¢×”)" },
            { id: "car_fix", label: "×¨×›×‘ (×‘×™×˜×•×—/×˜×¡×˜)", calc: true },
            { id: "other_fix", label: "××—×¨ (×œ×—×¥ ×œ×©×™× ×•×™)", editable: true }
        ];

        const VAR_EXP_LIST = [
            { id: "train_var", label: "×”×“×¨×›×” (××©×ª× ×”)" },
            { id: "conf", label: "×›× ×¡×™×/×”×©×ª×œ××•×™×•×ª" },
            { id: "mat", label: "×—×•××¨×™× ××ª×›×œ×™×" },
            { id: "books", label: "×¡×¤×¨×™×" },
            { id: "games", label: "××©×—×§×™×/×¢×–×¨×™×" },
            { id: "ads", label: "×¤×¨×¡×•× ×•×©×™×•×•×§" },
            { id: "food", label: "×›×™×‘×•×“" },
            { id: "consult", label: "×™×¢×•×¥ ×¢×¡×§×™" },
            { id: "car_var", label: "×¨×›×‘ (×“×œ×§/×˜×™×¤×•×œ)", calc: true },
            { id: "don", label: "×ª×¨×•××•×ª" },
            { id: "other_var", label: "××—×¨ (×œ×—×¥ ×œ×©×™× ×•×™)", editable: true }
        ];

        let history = JSON.parse(localStorage.getItem('osek_history_v7')) || [];
        let savedFixed = JSON.parse(localStorage.getItem('osek_fixed_exp_v7')) || {};
        let currentInputForCalc = null; // Tracks which input opened the calculator

        // --- INIT ---
        window.onload = () => {
            renderExpenses();
            calculate();
            updateAnnualDashboard();
            
            // Modal Logic Listeners
            document.getElementById('modal-full-amount').addEventListener('input', updateModalCalc);
            document.getElementById('modal-percent').addEventListener('input', updateModalCalc);
        };

        function renderExpenses() {
            // Render Fixed
            const fixContainer = document.getElementById('fixed-exp-container');
            fixContainer.innerHTML = FIXED_EXP_LIST.map(item => generateExpHTML(item, 'fixed')).join('');

            // Render Variable
            const varContainer = document.getElementById('var-exp-container');
            varContainer.innerHTML = VAR_EXP_LIST.map(item => generateExpHTML(item, 'var')).join('');
        }

        function generateExpHTML(item, type) {
            const savedVal = type === 'fixed' && savedFixed[item.id] ? savedFixed[item.id].val : "";
            const savedFreq = type === 'fixed' && savedFixed[item.id] ? savedFixed[item.id].freq : "1";
            const savedLabel = type === 'fixed' && savedFixed[item.id] && savedFixed[item.id].customLabel ? savedFixed[item.id].customLabel : item.label;

            let labelHTML = `<label class="text-[11px] font-bold text-slate-500">${item.label}</label>`;
            if (item.editable) {
                labelHTML = `<input type="text" data-custom-label-id="${item.id}" value="${savedLabel}" class="editable-label mb-1">`;
            }

            let calcBtn = item.calc ? `<button onclick="openCalculator('${item.id}', '${type}')" class="bg-blue-100 text-blue-600 px-2 rounded hover:bg-blue-200" title="××—×©×‘×•×Ÿ ×”×•×¦××” ××•×›×¨×ª">ğŸ§®</button>` : '';
            
            let freqSelect = '';
            if (type === 'fixed') {
                freqSelect = `
                    <select data-freq="${item.id}" class="text-[10px] border rounded bg-slate-50" onchange="calculate()">
                        <option value="1" ${savedFreq=="1"?'selected':''}>×—×•×“×©×™</option>
                        <option value="2" ${savedFreq=="2"?'selected':''}>×“×•-×—×•×“×©×™</option>
                        <option value="12" ${savedFreq=="12"?'selected':''}>×©× ×ª×™</option>
                    </select>
                `;
            }

            return `
                <div class="flex flex-col">
                    ${labelHTML}
                    <div class="flex gap-1 h-9">
                        <input type="number" id="inp-${type}-${item.id}" data-group="${type}" data-id="${item.id}" value="${savedVal}" class="input-field text-sm flex-grow" oninput="calculate()">
                        ${calcBtn}
                        ${freqSelect}
                    </div>
                </div>
            `;
        }

        // --- CALCULATIONS ---
        function calculateTax(amount) {
            let tax = 0;
            let prevLimit = 0;
            for (let b of C.TAX) {
                if (amount > prevLimit) {
                    let taxable = Math.min(amount - prevLimit, b.limit - prevLimit);
                    tax += taxable * b.rate;
                    prevLimit = b.limit;
                }
            }
            if (amount > prevLimit) tax += (amount - prevLimit) * 0.47;
            return tax;
        }

        function calculate() {
            // 1. Income
            let income = 0;
            document.querySelectorAll('[data-group="inc"]').forEach(i => income += parseFloat(i.value) || 0);
            document.getElementById('total-income-val').innerText = income.toLocaleString();

            // 2. Expenses
            let fixedExpTotal = 0;
            document.querySelectorAll('[data-group="fixed"]').forEach(i => {
                const id = i.dataset.id;
                const freq = parseFloat(document.querySelector(`[data-freq="${id}"]`).value);
                fixedExpTotal += (parseFloat(i.value) || 0) / freq;
            });

            let varExpTotal = 0;
            document.querySelectorAll('[data-group="var"]').forEach(i => varExpTotal += parseFloat(i.value) || 0);
            
            document.getElementById('receipt-reminder').classList.toggle('hidden', varExpTotal === 0);

            // 3. Profit
            const profit = Math.max(0, income - (fixedExpTotal + varExpTotal));

            // 4. Profile Inputs
            const salary = parseFloat(document.getElementById('salary').value) || 0;
            const gender = document.getElementById('gender').value;
            const children = parseInt(document.getElementById('children').value) || 0;
            
            // Credit Points Logic
            let points = (gender === 'male' ? 2.25 : 2.75) + children;
            if (document.getElementById('degree').checked) points += 1;
            points += parseFloat(document.getElementById('extraPoints').value) || 0;
            
            const creditValue = points * C.CREDIT_POINT;

            // 5. Update Status Card
            updateStatus(salary, profit, creditValue);

            // 6. Final Results
            if (income > 0) {
                document.getElementById('results-area').classList.replace('opacity-0', 'opacity-100');
                
                // Pension
                let pension = 0;
                const halfAvg = C.AVG_WAGE / 2;
                if (profit <= halfAvg) pension = profit * C.PENSION_R1;
                else if (profit <= C.AVG_WAGE) pension = (halfAvg * C.PENSION_R1) + ((profit - halfAvg) * C.PENSION_R2);
                else pension = (halfAvg * C.PENSION_R1) + ((C.AVG_WAGE - halfAvg) * C.PENSION_R2);

                // Bituach Leumi (Stacking)
                let usedLowRate = Math.min(salary, C.BITUACH_LIMIT);
                let profitAtLowRate = Math.min(profit, Math.max(0, C.BITUACH_LIMIT - usedLowRate));
                let bituach = (profitAtLowRate * C.BITUACH_R1) + (Math.max(0, profit - profitAtLowRate) * C.BITUACH_R2);

                // Tax Calculation
                let totalIncome = salary + profit;
                let rawTaxTotal = calculateTax(totalIncome);
                let rawTaxSalary = calculateTax(salary);
                
                let taxLiabilityTotal = Math.max(0, rawTaxTotal - creditValue);
                // Assume Salary uses its share of credits first
                // (Simplified: We assume salary was taxed correctly at
